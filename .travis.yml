---
sudo: false
language: rust
os:
  - linux
  - osx
dist: trusty
osx_image: xcode9.2
rust: stable
env:
  global:
    - THERMITE_DEBUG_FILENAME: /tmp/thermite-debug.log
  matrix:
    - FWOOTHEE_RUBY_VERSION: 2.3.5
    - FWOOTHEE_RUBY_VERSION: 2.4.2
    - FWOOTHEE_RUBY_VERSION: 2.5.0
matrix:
  include:
    - os: linux
      dist: trusty
      env: FWOOTHEE_RUBY_VERSION=2.3.5 RUBY_STATIC=1
    - os: linux
      dist: trusty
      env: FWOOTHEE_RUBY_VERSION=2.4.2 RUBY_STATIC=1
    - os: linux
      dist: trusty
      env: FWOOTHEE_RUBY_VERSION=2.5.0 RUBY_STATIC=1
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.3.5
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.3.5
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.3.5 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.2
      env: FWOOTHEE_RUBY_VERSION=2.3.5 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.3.5 RUBY_STATIC=1
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.4.2
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.4.2
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.4.2 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.2
      env: FWOOTHEE_RUBY_VERSION=2.4.2 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.4.2 RUBY_STATIC=1
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.5.0
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.5.0
    - os: osx
      osx_image: xcode8
      env: FWOOTHEE_RUBY_VERSION=2.5.0 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.2
      env: FWOOTHEE_RUBY_VERSION=2.5.0 RUBY_STATIC=1
    - os: osx
      osx_image: xcode9.3beta
      env: FWOOTHEE_RUBY_VERSION=2.5.0 RUBY_STATIC=1

cache:
  cargo: true
  directories:
    - $TRAVIS_BUILD_DIR/vendor/bundle

before_install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew update
    fi
    rvm install "$FWOOTHEE_RUBY_VERSION"
    rvm use "$FWOOTHEE_RUBY_VERSION"
    ruby --version
    if [[ "$TRAVIS_OS_NAME" == "osx" ]] && ! which bundle > /dev/null; then
      gem install bundler
    fi
  - bundle install --jobs=3 --retry=3 --path=$TRAVIS_BUILD_DIR/vendor/bundle

script:
  - bundle exec rake spec
  - bundle exec rake thermite:tarball
  - bundle exec rake install
  - |
    if [[ -z "$TRAVIS_TAG" ]]; then
      gem uninstall fast_woothee
      CARGO=fake bundle exec rake install
    fi
  - |
    if [[ -z "$TRAVIS_TAG" ]]; then
      gem uninstall fast_woothee
      CARGO=fake gem install pkg/*.gem
      bundle exec rake spec
    fi
  - if [[ -f "$THERMITE_DEBUG_FILENAME" ]]; then cat $THERMITE_DEBUG_FILENAME; fi

deploy:
  provider: releases
  api_key:
    secure: Dy3Ljq0N023aRdLbJOGB9zp7+JNlN0w4Bg07OKOBj6RSGWjSgzTQbHT5xY2ZRaSeo0gmgiSxjePdo0GL4k3hL3k7SiHBwE17dUHURYY9PV+Cszy8ygV1Jqr5z7KUmSJrmBEZ9rK/Dg9ZJgsMVHfLZZJYM5QYxAwWrPhXdTFQltZB/b6PwEID7/kyug+jWo8DqH4iyoqLEyNPB8LdS/ksqg/VvMAWNvHlnDlvHTO5Cq1BAzvtzxxY5GjOfhzBGuPLYjeQZiEJ4Ljcg3JJSU3W2rU7El3Yew2PCnV1U5AdUdG0Lm9TecUQ+WK7Zfz/dSsOdzQWWp1x37BqnNmPh9KQqrhP18X795foKm6wDWcEs6ABq5uxmWtDN9/x5l2t8OY5VmqlfoBgyntISpOIXxJB2PA/hJGiw5tMAXNw6jUonG5xYa93Av+NopcC5FJd+NQRv6knTPEtRS5ZY8XY2fNldIqY2vRGlpOmk8EQDnbsPbyqH9dDc7eJWSPZV3FEdgxTUe5EbGUvO47jWZFhRe2aj/9y/uy6yTLNTvO9B1zoC2/MGq9Y3/Tacd9Stf8LTWnze11Y3SQT/xhFm+QMk10N7aHT58KwLYlC+rcH76C2w7avGAX0rEpkVg3iIMCL246O9iWktxwHkmjXlF04ME4wO9VzGYUva6tQt6wIxle6Z+s=
  file: fast_woothee-*.tar.gz
  file_glob: true
  skip_cleanup: true
  on:
    condition: ${TRAVIS_TAG} =~ '-rust'
    repo: ianks/fast_woothee
    tags: true
